<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prueba WebSocket - Autenticaci√≥n</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        display: flex;
        gap: 20px;
      }
      .panel {
        flex: 1;
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 8px;
      }
      .jugador {
        background-color: #e3f2fd;
      }
      .cajero {
        background-color: #f3e5f5;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .authenticated {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .message {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        font-size: 12px;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      input,
      textarea {
        width: 100%;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      #messages {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin: 10px 0;
        background-color: #f8f9fa;
      }
    </style>
  </head>
  <body>
    <h1>üß™ Prueba WebSocket - Autenticaci√≥n y Comunicaci√≥n</h1>

    <div class="container">
      <!-- Panel Jugador -->
      <div class="panel jugador">
        <h2>üë§ Jugador (Dep√≥sitos)</h2>

        <div id="jugador-status" class="status disconnected">
          ‚ùå Desconectado
        </div>

        <div>
          <button onclick="conectarJugador()">Conectar</button>
          <button onclick="desconectarJugador()">Desconectar</button>
        </div>

        <div>
          <h3>Autenticaci√≥n</h3>
          <input
            type="text"
            id="jugador-telegramId"
            placeholder="Telegram ID"
            value="123456789"
          />
          <textarea id="jugador-initData" placeholder="Init Data (simulado)">
user=%7B%22id%22%3A123456789%7D&auth_date=1234567890&hash=abc123</textarea
          >
          <button onclick="autenticarJugador()">Autenticar Jugador</button>
        </div>

        <div>
          <h3>Solicitar Dep√≥sito</h3>
          <input
            type="number"
            id="jugador-monto"
            placeholder="Monto"
            value="100"
          />
          <input
            type="text"
            id="jugador-metodo"
            placeholder="M√©todo"
            value="Pago M√≥vil"
          />
          <button onclick="solicitarDeposito()">Solicitar Dep√≥sito</button>
        </div>

        <div id="jugador-messages" class="messages"></div>
      </div>

      <!-- Panel Cajero -->
      <div class="panel cajero">
        <h2>üè¶ Cajero</h2>

        <div id="cajero-status" class="status disconnected">
          ‚ùå Desconectado
        </div>

        <div>
          <button onclick="conectarCajero()">Conectar</button>
          <button onclick="desconectarCajero()">Desconectar</button>
        </div>

        <div>
          <h3>Autenticaci√≥n</h3>
           <textarea id="cajero-token" placeholder="JWT Token">
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4ODQzMTk1Y2NmNDZmOTgxYmU3ZGYyMCIsImVtYWlsIjoibHVpc0BlamVtcGxvLmNvbSIsInJvbCI6ImNhamVybyIsImlhdCI6MTc1OTA4ODYwOSwiZXhwIjoxNzU5MTc1MDA5fQ.YAO4X_HaNOFrYSHODyORdyN27TwmBeBALSkABh8-WAU</textarea
           >
          <button onclick="autenticarCajero()">Autenticar Cajero</button>
        </div>

        <div>
          <h3>Acciones</h3>
          <input
            type="text"
            id="cajero-socketId"
            placeholder="Socket ID del Jugador"
          />
          <button onclick="atenderDeposito()">Atender Dep√≥sito</button>
          <button onclick="confirmarDeposito()">Confirmar Dep√≥sito</button>
          <button onclick="rechazarDeposito()">Rechazar Dep√≥sito</button>
        </div>

        <div id="cajero-messages" class="messages"></div>
      </div>
    </div>

    <script>
      let jugadorSocket = null;
      let cajeroSocket = null;

      // Detectar URL del servidor
      const isRailway = window.location.hostname.includes("railway.app");
      const socketUrl = isRailway
        ? "https://elpatio-backend-production.up.railway.app"
        : "http://localhost:3001";

      // === JUGADOR ===
      function conectarJugador() {
        if (jugadorSocket) {
          addJugadorMessage("Ya hay una conexi√≥n activa");
          return;
        }

        addJugadorMessage(`Conectando a: ${socketUrl}`);
        jugadorSocket = io(socketUrl, {
          transports: ["websocket", "polling"],
          timeout: 20000,
          forceNew: true,
        });

        jugadorSocket.on("connect", () => {
          addJugadorMessage("‚úÖ Conectado al servidor WebSocket");
          updateJugadorStatus(true);
        });

        jugadorSocket.on("disconnect", (reason) => {
          addJugadorMessage(`‚ùå Desconectado: ${reason}`);
          updateJugadorStatus(false);
        });

        jugadorSocket.on("auth-result", (result) => {
          if (result.success) {
            addJugadorMessage(
              `üîê Autenticado: ${result.user.nickname || result.user.firstName}`
            );
            updateJugadorStatus(true, true);
          } else {
            addJugadorMessage(`‚ùå Error de autenticaci√≥n: ${result.message}`);
          }
        });

        jugadorSocket.on("deposito-atendido", (data) => {
          addJugadorMessage(
            `üè¶ Dep√≥sito atendido por cajero: ${data.cajeroId}`
          );
        });

        jugadorSocket.on("deposito-confirmado", (data) => {
          addJugadorMessage(`‚úÖ Dep√≥sito confirmado: ${data.transaccionId}`);
        });

        jugadorSocket.on("deposito-rechazado", (data) => {
          addJugadorMessage(`‚ùå Dep√≥sito rechazado: ${data.motivo}`);
        });

        jugadorSocket.on("error", (error) => {
          addJugadorMessage(`‚ùå Error: ${error.message}`);
        });
      }

      function desconectarJugador() {
        if (jugadorSocket) {
          jugadorSocket.disconnect();
          jugadorSocket = null;
          updateJugadorStatus(false);
          addJugadorMessage("Desconectado manualmente");
        }
      }

      function autenticarJugador() {
        if (!jugadorSocket || !jugadorSocket.connected) {
          addJugadorMessage("‚ùå No hay conexi√≥n activa");
          return;
        }

        const telegramId = document.getElementById("jugador-telegramId").value;
        const initData = document.getElementById("jugador-initData").value;

        addJugadorMessage(`üîê Autenticando jugador: ${telegramId}`);
        jugadorSocket.emit("authenticate-jugador", {
          telegramId: parseInt(telegramId),
          initData,
        });
      }

      function solicitarDeposito() {
        if (!jugadorSocket || !jugadorSocket.connected) {
          addJugadorMessage("‚ùå No hay conexi√≥n activa");
          return;
        }

        const monto = document.getElementById("jugador-monto").value;
        const metodo = document.getElementById("jugador-metodo").value;

        addJugadorMessage(`üí∞ Solicitando dep√≥sito: $${monto} - ${metodo}`);
        jugadorSocket.emit("solicitar-deposito", {
          monto: parseFloat(monto),
          metodo,
          timestamp: new Date().toISOString(),
        });
      }

      // === CAJERO ===
      function conectarCajero() {
        if (cajeroSocket) {
          addCajeroMessage("Ya hay una conexi√≥n activa");
          return;
        }

        addCajeroMessage(`Conectando a: ${socketUrl}`);
        cajeroSocket = io(socketUrl, {
          transports: ["websocket", "polling"],
          timeout: 20000,
          forceNew: true,
        });

        cajeroSocket.on("connect", () => {
          addCajeroMessage("‚úÖ Conectado al servidor WebSocket");
          updateCajeroStatus(true);
        });

        cajeroSocket.on("disconnect", (reason) => {
          addCajeroMessage(`‚ùå Desconectado: ${reason}`);
          updateCajeroStatus(false);
        });

        cajeroSocket.on("auth-result", (result) => {
          if (result.success) {
            addCajeroMessage(`üîê Autenticado: ${result.user.nombre}`);
            updateCajeroStatus(true, true);
          } else {
            addCajeroMessage(`‚ùå Error de autenticaci√≥n: ${result.message}`);
          }
        });

        cajeroSocket.on("nueva-solicitud-deposito", (data) => {
          addCajeroMessage(
            `üí∞ Nueva solicitud de dep√≥sito de jugador ${data.jugadorId}`
          );
          addCajeroMessage(`   Monto: $${data.monto} - M√©todo: ${data.metodo}`);
          addCajeroMessage(`   Socket ID: ${data.socketId}`);

          // Auto-llenar el socket ID para facilitar las pruebas
          document.getElementById("cajero-socketId").value = data.socketId;
        });

        cajeroSocket.on("error", (error) => {
          addCajeroMessage(`‚ùå Error: ${error.message}`);
        });
      }

      function desconectarCajero() {
        if (cajeroSocket) {
          cajeroSocket.disconnect();
          cajeroSocket = null;
          updateCajeroStatus(false);
          addCajeroMessage("Desconectado manualmente");
        }
      }

      function autenticarCajero() {
        if (!cajeroSocket || !cajeroSocket.connected) {
          addCajeroMessage("‚ùå No hay conexi√≥n activa");
          return;
        }

        const token = document.getElementById("cajero-token").value;
        addCajeroMessage("üîê Autenticando cajero...");
        cajeroSocket.emit("authenticate-cajero", { token });
      }

      function atenderDeposito() {
        if (!cajeroSocket || !cajeroSocket.connected) {
          addCajeroMessage("‚ùå No hay conexi√≥n activa");
          return;
        }

        const jugadorSocketId =
          document.getElementById("cajero-socketId").value;
        if (!jugadorSocketId) {
          addCajeroMessage("‚ùå Ingresa el Socket ID del jugador");
          return;
        }

        addCajeroMessage(
          `üè¶ Atendiendo dep√≥sito del jugador: ${jugadorSocketId}`
        );
        cajeroSocket.emit("atender-deposito", {
          jugadorSocketId,
          timestamp: new Date().toISOString(),
        });
      }

      function confirmarDeposito() {
        if (!cajeroSocket || !cajeroSocket.connected) {
          addCajeroMessage("‚ùå No hay conexi√≥n activa");
          return;
        }

        const jugadorSocketId =
          document.getElementById("cajero-socketId").value;
        if (!jugadorSocketId) {
          addCajeroMessage("‚ùå Ingresa el Socket ID del jugador");
          return;
        }

        const transaccionId = "TXN_" + Date.now();
        addCajeroMessage(`‚úÖ Confirmando dep√≥sito: ${transaccionId}`);
        cajeroSocket.emit("confirmar-deposito", {
          jugadorSocketId,
          transaccionId,
        });
      }

      function rechazarDeposito() {
        if (!cajeroSocket || !cajeroSocket.connected) {
          addCajeroMessage("‚ùå No hay conexi√≥n activa");
          return;
        }

        const jugadorSocketId =
          document.getElementById("cajero-socketId").value;
        if (!jugadorSocketId) {
          addCajeroMessage("‚ùå Ingresa el Socket ID del jugador");
          return;
        }

        const motivo =
          prompt("Motivo del rechazo:") || "Motivo no especificado";
        addCajeroMessage(`‚ùå Rechazando dep√≥sito: ${motivo}`);
        cajeroSocket.emit("rechazar-deposito", {
          jugadorSocketId,
          motivo,
        });
      }

      // === UTILIDADES ===
      function addJugadorMessage(message) {
        const messagesDiv = document.getElementById("jugador-messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";
        messageDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function addCajeroMessage(message) {
        const messagesDiv = document.getElementById("cajero-messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";
        messageDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function updateJugadorStatus(connected, authenticated = false) {
        const statusDiv = document.getElementById("jugador-status");
        if (authenticated) {
          statusDiv.className = "status authenticated";
          statusDiv.textContent = "üîê Autenticado";
        } else if (connected) {
          statusDiv.className = "status connected";
          statusDiv.textContent = "‚úÖ Conectado";
        } else {
          statusDiv.className = "status disconnected";
          statusDiv.textContent = "‚ùå Desconectado";
        }
      }

      function updateCajeroStatus(connected, authenticated = false) {
        const statusDiv = document.getElementById("cajero-status");
        if (authenticated) {
          statusDiv.className = "status authenticated";
          statusDiv.textContent = "üîê Autenticado";
        } else if (connected) {
          statusDiv.className = "status connected";
          statusDiv.textContent = "‚úÖ Conectado";
        } else {
          statusDiv.className = "status disconnected";
          statusDiv.textContent = "‚ùå Desconectado";
        }
      }

      // Inicializar
      window.onload = () => {
        addJugadorMessage(
          `P√°gina cargada. Servidor: ${isRailway ? "Railway" : "Local"}`
        );
        addCajeroMessage(
          `P√°gina cargada. Servidor: ${isRailway ? "Railway" : "Local"}`
        );
      };
    </script>
  </body>
</html>
